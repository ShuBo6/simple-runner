
# 前期准备
本文基于已有的企业级CICD平台的设计方案和实现思路，来自己实现一套更轻量、更简单适合个人开发者小规模测试学习的CICD平台。其对运行环境的基础设施要求低，能够快速拉起。相较于大型的企业级的CICD流水线的微服务依赖做了简化。
## 1.1 背景调查

作者：人邮异步社区
链接：https://www.zhihu.com/question/63927805/answer/2067222080
来源：知乎
著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。

云的核心理念是弹性，站在云的视角，过去我们常以虚拟化作为云平台和与客户系统交互的界面，为企业带来灵活性的同时也带来了一定的管理复杂度。容器的出现，在虚拟化的基础上向上封装了一层，逐步成为云平台和与客户系统交互的新界面之一，应用的构建、分发和交付得以在这个层面上实现标准化，大幅降低了企业 IT 实施和运维成本，提升了业务创新的效率。从技术发展的角度看：开源让云计算变得越来越标准化，容器已经成为企业应用分发和交付的标准，可以将应用与底层运行环境解耦；Kubernetes成为资源调度和编排的标准，屏蔽了底层架构的差异性，帮助应用平滑运行在不同的基础设施上；在此基础上建立上层应用抽象（如微服务和服务网格），逐步形成应用架构现代化演进的标准，开发者只需要关注自身的业务逻辑，无须关注底层实现。云原生正在通过方法论、工具集和理念重塑整个软件技术栈和生命周期，帮助企业和开发者在云上构建和运行可弹性扩展、容错性好、易于管理、便于观察的系统。有了诸多标准化的产品技术，企业上云的拐点已经到来，云原生已经成为释放云价值的最短路径之一。云并非把原先在物理服务器上运行的东西放到虚拟机里运行，真正的云化不仅是基础设施和平台的事情，应用也要改变传统的做法，实现云化的应用——应用的架构、应用的开发方式、应用部署和维护技术等都要做出改变，真正发挥云的弹性、动态调度、自动伸缩等一些传统IT所不具备的能力。这里说的“云化的应用”也就是“云原生应用”。云原生架构和云原生应用所涉及的技术很多，如容器技术、微服务、可持续交付、DevOps等。


一个软件从零开始到最终交付，大概包括以下几个阶段：规划、编码、构建、测试、发布、部署和维护。最初，程序比较简单，工作量不大，程序员一个人可以完成所有阶段的工作。

随着软件产业的日益发展壮大，软件的规模也在逐渐变得庞大。软件的复杂度不断攀升。就开始出现了精细化分工。码农的队伍扩大，工种增加。除了软件开发工程师之外，又有了软件测试工程师，软件运维工程师。
软件开发人员花费数周和数月编写代码，然后将代码交给QA（质量保障）团队进行测试，然后将最终的发布版交给运维团队去布署。所有的这三个阶段，即开发，测试，布署。
早期所采用的软件交付模型，称之为“瀑布（Waterfall）模型”。而随着需求的

DevOps（Development和Operations的组合词）是一组过程、方法与系统的统称，用于促进开发（应用程序/软件工程）、技术运营和质量保障（QA）部门之间的沟通、协作与整合。它是一种重视“软件开发人员（Dev）”和“IT运维技术人员（Ops）”之间沟通合作的文化、运动或惯例。透过自动化“软件交付”和“架构变更”的流程，来使得构建、测试、发布软件能够更加地快捷、频繁和可靠。它的出现是由于软件行业日益清晰地认识到：为了按时交付软件产品和服务，开发和运维工作必须紧密合作。





云原生技术有利于各组织在公有云、私有云和混合云等新型动态环境中，构建和运行可弹性扩展的应用。云原生的代表技术包括容器、服务网格、微服务、不可变基础设施和声明式API。

这些技术能够构建容错性好、易于管理和便于观察的松耦合系统。结合可靠的自动化手段，云原生技术使工程师能够轻松地对系统作出频繁和可预测的重大变更。

云原生计算基金会（CNCF）致力于培育和维护一个厂商中立的开源生态系统，来推广云原生技术。我们通过将最前沿的模式民主化，让这些创新为大众所用。



## 1.2 技术调研

GitOps 是一种方法，通过声明式清单来管理 Kubernetes 集群，以强制执行自我修复和自我调整，达到你所期望的状态。

与传统的 CI/CD 管道相比，GitOps 采用了拉与推的模式。这意味着开发人员和运维人员不需要调用管道来推送变更到集群中。开发人员只需在源控制中更新他们的 Kubernetes 清单，在集群上运行的 GitOps 控制器将拉取这些变更，并应用所需的状态。因此，Git 成为环境中的唯一的事实来源。

在过去 11 年的行业观察中，我发现了从 TeamCity 到 Jenkins 到 Gitlab 等众多 CI/CD 系统的好处和陷阱。我在各组织中看到的一个共同模式是共享 CI/CD 基础设施。一台或几台构建服务器被几十个团队共享，这往往导致服务器方面的资源争夺，间歇性的网络问题，频繁的中断，这些都成为开发团队无法推送构建的瓶颈。当然，这些系统有许多好处，但肯定有更好的方法。

很多时候，团队由于对共享服务的依赖而退步。

GitOps 允许我们横向扩展集群的数量，因为每个集群都支持自我调节和自我修复。

Jenkins
## 1.3 技术方案
使用golang语言从最简单的shell命令，到封装docker构建模板通过保存 要执行的脚本和模板，简化编译构建以及部署的操作，用户只需要在网页上进行操作，或者借用webhook，自动触发构建任务。

下面以部署一个web程序为例子，演示本devops平台的ci/cd设计和最佳实践

# 后台设计

## simple-cicd

现在已有 api->执行sh

还需要：
    打通gitlab,代码拉取
    sh 执行模板保存修改删除，执行历史记录保存
    dockerbuild 执行模板保存修改删除，执行历史记录保存，执行后推送到镜像仓库
    执行结果邮件通知


### ci:脚本执行、dockerfile文件构建支持

### cd:脚本部署、docker-compose部署、k8s-helm部署
已有 api->执行sh
还需要：
    docker-compose 保存、修改、删除
    helmchart 保存、修改、删除

    一键拉起sh、docker、helm应用，拉起时的日志保存。
# 中台设计
需要:
    user 表设计
    gin jwt中间件（可以直接用gva）

## 身份权限、API暴露

# 前台设计

## VUE全家桶
需要：
    任务管理->构建任务列表->构建历史列表
    构建模板管理->构建模板列表->构建模板详情
    部署模板管理->部署模板列表->部署模板详情


# 部署环境



# 展望

# 致辞